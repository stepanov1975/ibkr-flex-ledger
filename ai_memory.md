- [2026-02-14] DECISION :: MVP scope documented in MVP.md with seven core feature groups: ingestion, canonical events, stocks-first ledger, labels/notes, reporting drilldown, reconciliation modes, and operational reliability gates.
- [2026-02-14] DECISION :: Modular-first policy is mandatory: structure MVP modules for future phase expansion, but do not implement max_plan.md phase 2+ features in initial delivery.
- [2026-02-14] DECISION :: Database access boundary is strict: only db-layer modules execute SQL/ORM queries; all other layers must use db interfaces/repositories.
- [2026-02-14] DECISION :: Environment baseline includes PostgreSQL 17 installed with cluster 17/main online on port 5432.
- [2026-02-14] PATTERN :: Keep external IBKR/Flex repositories under references/ as read-only study material; reuse architecture patterns (parser boundary, poll-download flow, report section checklist) without direct code copy.
- [2026-02-14] DECISION :: Pre-implementation protocol requires scanning references/REFERENCE_NOTES.md before any feature work or significant bug fix to maximize reuse and prevent duplicate design effort.
- [2026-02-14] DECISION :: MVP.md now encodes resolved evaluation policies as explicit requirements: idempotency (period_key + flex_query_id + sha256 plus canonical UPSERT), conid-first identity, EOD mark and FX fallback rules, reconciliation tolerance policy, manual corporate-action workflow, reverse-proxy auth boundary, retention defaults, missing-section failure handling, and CSV export baseline.
- [2026-02-14] DECISION :: MVP scope is explicitly single IBKR account; multi-account ingestion and reporting are post-MVP only.
- [2026-02-14] DECISION :: Canonical time handling is fixed project-wide: persist timestamps in UTC and apply Asia/Jerusalem for UI and business date boundaries.
- [2026-02-14] DECISION :: MVP keeps reverse-proxy authentication boundary but defers proxy-header trust hardening checks to post-MVP.
- [2026-02-14] PATTERN :: MVP.md includes a specification-freeze checklist requiring concrete values for natural keys, fallback hierarchies, corporate-action allowlist, tolerance matrix, SLO targets, CSV contracts, and derived-data retention windows.
- [2026-02-14] DECISION :: MVP_spec_freeze.md now contains a frozen v1 baseline from references: execution-id keyed trade dedup (`ib_exec_id`), deterministic EOD/FX fallback order, explicit corporate-action auto/manual allowlist, tolerance formulas and thresholds, SLO targets, CSV column contracts, and derived-diagnostics retention windows.
- [2026-02-14] DECISION :: Corporate-action automation boundary frozen for MVP: auto only deterministic cash/metadata actions (`CD`, `CP`, `FA`, `IC`, CUSIP/ISIN alias changes); `FS`/`FI`/`RS` are auto only when ratio inference is unambiguous; all election, multi-leg, cost-basis allocation, stock-dividend/delist-worthless, and option-deliverable adjustment actions are manual case workflow.
- [2026-02-14] DECISION :: EOD mark fallback frozen as `OpenPositions.markPrice` -> same-day `Trades.closePrice` -> last known `Trades.tradePrice` on/before report date; tie-break is latest `dateTime`, then highest `transactionID`, then highest raw record primary key; if none available emit `EOD_MARK_MISSING_ALL_SOURCES` and mark provisional.
- [2026-02-14] DECISION :: FX fallback frozen as `Trades.fxRateToBase` -> derived `abs(netCashInBase)/abs(netCash)` -> `ConversionRates` exact-date then nearest-previous; tie-break for same-date rates is latest `ingestion_run_id` then highest raw record primary key; if missing for non-base currencies emit `FX_RATE_MISSING_ALL_SOURCES` and mark provisional.
- [2026-02-14] DECISION :: Reconciliation tolerance matrix frozen: PnL/fees/withholding use abs `max(0.01, minor_unit)` and rel `0.0001` with currency minor-unit precision; quantity uses abs `0.000001` and rel `0`; shared formula is `abs(a-b) <= abs_tol OR abs(a-b)/max(abs(b),1e-9) <= rel_tol` (quantity uses absolute-only check).
- [2026-02-14] DECISION :: MVP SLO targets frozen: ingestion success rate `>=99.0%` (rolling 30d), ingestion duration `p95<=15m` (rolling 14d), and RTO `<=4h`; alert at success `<98.0%`, any run `>30m`, or incident unresolved at `2h`.
- [2026-02-14] DECISION :: Ingestion observability requirement frozen: every ingestion run must produce detailed structured logs (stage, source reference, error code/message, exception type, stack trace, retry metadata) and a human-readable failure summary linked by `run_id`.
- [2026-02-14] DECISION :: MVP diagnostics UX baseline frozen: ingestion runs page must show run status/duration, stage timeline, structured error panel, source trace fields, retry metadata, and copyable `run_id`/error payload for support workflows.
- [2026-02-14] DECISION :: CSV export contracts frozen at schema `v1` for three endpoints (`/reports/pnl/by-instrument`, `/reports/pnl/by-label`, `/reports/reconciliation/diff`) with fixed column order, datatype/nullability rules, and breaking-change version bump policy.
- [2026-02-14] DECISION :: Derived diagnostics retention frozen to 60 days hot for ingestion, reprocess, and snapshot diagnostics; immutable raw payload retention remains indefinite.
- [2026-02-14] DECISION :: MVP security boundary freeze: no reverse-proxy identity header contract checks in app code during MVP; proxy-trust validation and header enforcement are deferred to post-MVP hardening.
- [2026-02-14] DECISION :: MVP.md synchronized with MVP_evaluation freeze outputs: explicit single-site/no-backward-compat policy, parser/ingestion boundary rules, corporate-action scope rule, and full CSV `v1` column contracts for all reporting exports.
- [2026-02-14] DECISION :: Corporate-action `SD` (stock dividend) policy finalized as auto-when-deterministic; manual workflow remains required for ambiguous/election/multi-leg/cost-basis allocation cases.
- [2026-02-14] DECISION :: `pnl_snapshot_daily` is mandatory in MVP for deterministic day-level reporting and reconciliation outputs.
- [2026-02-14] DECISION :: MVP base reporting currency is fixed to `USD` at initial setup and cannot be changed during MVP.
- [2026-02-14] DECISION :: Ingestion overlap policy is finalized: single active run lock and reject concurrent trigger attempts with `409` and message `run already active`.
- [2026-02-14] DECISION :: Flex section matrix for MVP finalized: hard-required sections are `Trades`, `OpenPositions`, `CashTransactions`, `CorporateActions`, `ConversionRates`, `SecuritiesInfo`, `AccountInformation`; reconciliation-required sections are `MTMPerformanceSummaryInBase` and `FIFOPerformanceSummaryInBase`; additional sections (`InterestAccruals`, `ChangeInDividendAccruals`, `OpenDividendAccruals`, `ChangeInNAV`, `StmtFunds`, `UnbundledCommissionDetails`) should be ingested when present for future-proofing.
- [2026-02-14] DECISION :: Required Flex section matrix is now embedded in both `MVP.md` and `MVP_spec_freeze.md`, with deterministic failure diagnostics (`MISSING_REQUIRED_SECTION`) for missing required sections.
- [2026-02-14] DECISION :: API list contract baseline finalized for MVP: common `limit`/`offset`/`sort_by`/`sort_dir` parameters, configurable defaults (`API_DEFAULT_LIMIT=50`, `API_MAX_LIMIT=200`), deterministic endpoint-specific sort fields, normalized filter constraints, and uniform list response envelope with page/sort/filter metadata.
- [2026-02-14] DECISION :: API list contract has been embedded in both `MVP.md` and `MVP_spec_freeze.md` as frozen policy, including validation error codes and endpoint-specific sort/filter allowlists.
- [2026-02-14] DECISION :: Backup/restore policy frozen for MVP reliability: PostgreSQL full backup every 24h, WAL archive every 5m, PITR window 14 days, retention (14 daily / 8 weekly / 12 monthly), RPO <=15m, RTO <=4h, plus weekly restore smoke tests and monthly full restore drills with required runbook ownership.
- [2026-02-14] DECISION :: Manual corporate-action backlog behavior finalized: unresolved cases keep only affected instruments provisional and visible with unresolved counters; unrelated instruments and global report generation remain available.
- [2026-02-14] DECISION :: Single-account `account_id` API contract finalized: keep `account_id` internal-only in MVP API payloads, use fixed configured account context in backend repositories, defer external multi-account API exposure to post-MVP.
- [2026-02-14] DECISION :: Task 1 runtime foundation implemented with project-native FastAPI package layout under `app/` and explicit layer boundaries (`adapters`, `mapping`, `ledger`, `analytics`, `api`, `jobs`, `db`, `domain`).
- [2026-02-14] DECISION :: Startup configuration is validated via `pydantic-settings` with `.env` support for local development plus environment variable overrides for deployment.
- [2026-02-14] PATTERN :: Health endpoint pattern finalized: API layer delegates DB connectivity checks to `DatabaseHealthPort` implementation in `app/db`, returning deterministic `200 ok` or `503 degraded` payloads.
- [2026-02-14] DECISION :: Container baseline for Task 1 uses root `Dockerfile` and `docker-compose.yml` with app+postgres services and postgres host port mapping `5433:5432` to avoid collision with local host PostgreSQL on `5432`.