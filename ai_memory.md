- [2026-02-14] DECISION :: MVP scope documented in MVP.md with seven core feature groups: ingestion, canonical events, stocks-first ledger, labels/notes, reporting drilldown, reconciliation modes, and operational reliability gates.
- [2026-02-14] DECISION :: Modular-first policy is mandatory: structure MVP modules for future phase expansion, but do not implement max_plan.md phase 2+ features in initial delivery.
- [2026-02-14] DECISION :: Database access boundary is strict: only db-layer modules execute SQL/ORM queries; all other layers must use db interfaces/repositories.
- [2026-02-14] DECISION :: Local runtime is standardized to Docker PostgreSQL; host PostgreSQL server package was removed to prevent host/container DATABASE_URL drift.
- [2026-02-14] PATTERN :: Keep external IBKR/Flex repositories under references/ as read-only study material; reuse architecture patterns (parser boundary, poll-download flow, report section checklist) without direct code copy.
- [2026-02-14] DECISION :: Pre-implementation protocol requires scanning references/REFERENCE_NOTES.md before any feature work or significant bug fix to maximize reuse and prevent duplicate design effort.
- [2026-02-14] DECISION :: MVP.md now encodes resolved evaluation policies as explicit requirements: idempotency (period_key + flex_query_id + sha256 plus canonical UPSERT), conid-first identity, EOD mark and FX fallback rules, reconciliation tolerance policy, manual corporate-action workflow, reverse-proxy auth boundary, retention defaults, missing-section failure handling, and CSV export baseline.
- [2026-02-14] DECISION :: MVP scope is explicitly single IBKR account; multi-account ingestion and reporting are post-MVP only.
- [2026-02-14] DECISION :: Canonical time handling is fixed project-wide: persist timestamps in UTC and apply Asia/Jerusalem for UI and business date boundaries.
- [2026-02-14] DECISION :: MVP keeps reverse-proxy authentication boundary but defers proxy-header trust hardening checks to post-MVP.
- [2026-02-14] PATTERN :: MVP.md includes a specification-freeze checklist requiring concrete values for natural keys, fallback hierarchies, corporate-action allowlist, tolerance matrix, SLO targets, CSV contracts, and derived-data retention windows.
- [2026-02-14] DECISION :: MVP_spec_freeze.md now contains a frozen v1 baseline from references: execution-id keyed trade dedup (`ib_exec_id`), deterministic EOD/FX fallback order, explicit corporate-action auto/manual allowlist, tolerance formulas and thresholds, SLO targets, CSV column contracts, and derived-diagnostics retention windows.
- [2026-02-14] DECISION :: Corporate-action automation boundary frozen for MVP: auto only deterministic cash/metadata actions (`CD`, `CP`, `FA`, `IC`, CUSIP/ISIN alias changes); `FS`/`FI`/`RS` are auto only when ratio inference is unambiguous; all election, multi-leg, cost-basis allocation, stock-dividend/delist-worthless, and option-deliverable adjustment actions are manual case workflow.
- [2026-02-14] DECISION :: EOD mark fallback frozen as `OpenPositions.markPrice` -> same-day `Trades.closePrice` -> last known `Trades.tradePrice` on/before report date; tie-break is latest `dateTime`, then highest `transactionID`, then highest raw record primary key; if none available emit `EOD_MARK_MISSING_ALL_SOURCES` and mark provisional.
- [2026-02-14] DECISION :: FX fallback frozen as `Trades.fxRateToBase` -> derived `abs(netCashInBase)/abs(netCash)` -> `ConversionRates` exact-date then nearest-previous; tie-break for same-date rates is latest `ingestion_run_id` then highest raw record primary key; if missing for non-base currencies emit `FX_RATE_MISSING_ALL_SOURCES` and mark provisional.
- [2026-02-14] DECISION :: Reconciliation tolerance matrix frozen: PnL/fees/withholding use abs `max(0.01, minor_unit)` and rel `0.0001` with currency minor-unit precision; quantity uses abs `0.000001` and rel `0`; shared formula is `abs(a-b) <= abs_tol OR abs(a-b)/max(abs(b),1e-9) <= rel_tol` (quantity uses absolute-only check).
- [2026-02-14] DECISION :: MVP SLO targets frozen: ingestion success rate `>=99.0%` (rolling 30d), ingestion duration `p95<=15m` (rolling 14d), and RTO `<=4h`; alert at success `<98.0%`, any run `>30m`, or incident unresolved at `2h`.
- [2026-02-14] DECISION :: Ingestion observability requirement frozen: every ingestion run must produce detailed structured logs (stage, source reference, error code/message, exception type, stack trace, retry metadata) and a human-readable failure summary linked by `run_id`.
- [2026-02-14] DECISION :: MVP diagnostics UX baseline frozen: ingestion runs page must show run status/duration, stage timeline, structured error panel, source trace fields, retry metadata, and copyable `run_id`/error payload for support workflows.
- [2026-02-14] DECISION :: CSV export contracts frozen at schema `v1` for three endpoints (`/reports/pnl/by-instrument`, `/reports/pnl/by-label`, `/reports/reconciliation/diff`) with fixed column order, datatype/nullability rules, and breaking-change version bump policy.
- [2026-02-14] DECISION :: Derived diagnostics retention frozen to 60 days hot for ingestion, reprocess, and snapshot diagnostics; immutable raw payload retention remains indefinite.
- [2026-02-14] DECISION :: MVP security boundary freeze: no reverse-proxy identity header contract checks in app code during MVP; proxy-trust validation and header enforcement are deferred to post-MVP hardening.
- [2026-02-14] DECISION :: MVP.md synchronized with MVP_evaluation freeze outputs: explicit single-site/no-backward-compat policy, parser/ingestion boundary rules, corporate-action scope rule, and full CSV `v1` column contracts for all reporting exports.
- [2026-02-14] DECISION :: Corporate-action `SD` (stock dividend) policy finalized as auto-when-deterministic; manual workflow remains required for ambiguous/election/multi-leg/cost-basis allocation cases.
- [2026-02-14] DECISION :: `pnl_snapshot_daily` is mandatory in MVP for deterministic day-level reporting and reconciliation outputs.
- [2026-02-14] DECISION :: MVP base reporting currency is fixed to `USD` at initial setup and cannot be changed during MVP.
- [2026-02-14] DECISION :: Ingestion overlap policy is finalized: single active run lock and reject concurrent trigger attempts with `409` and message `run already active`.
- [2026-02-14] DECISION :: Flex section matrix for MVP finalized: hard-required sections are `Trades`, `OpenPositions`, `CashTransactions`, `CorporateActions`, `ConversionRates`, `SecuritiesInfo`, `AccountInformation`; reconciliation-required sections are `MTMPerformanceSummaryInBase` and `FIFOPerformanceSummaryInBase`; additional sections (`InterestAccruals`, `ChangeInDividendAccruals`, `OpenDividendAccruals`, `ChangeInNAV`, `StmtFunds`, `UnbundledCommissionDetails`) should be ingested when present for future-proofing.
- [2026-02-14] DECISION :: Required Flex section matrix is now embedded in both `MVP.md` and `MVP_spec_freeze.md`, with deterministic failure diagnostics (`MISSING_REQUIRED_SECTION`) for missing required sections.
- [2026-02-14] DECISION :: API list contract baseline finalized for MVP: common `limit`/`offset`/`sort_by`/`sort_dir` parameters, configurable defaults (`API_DEFAULT_LIMIT=50`, `API_MAX_LIMIT=200`), deterministic endpoint-specific sort fields, normalized filter constraints, and uniform list response envelope with page/sort/filter metadata.
- [2026-02-14] DECISION :: API list contract has been embedded in both `MVP.md` and `MVP_spec_freeze.md` as frozen policy, including validation error codes and endpoint-specific sort/filter allowlists.
- [2026-02-14] DECISION :: Backup/restore policy frozen for MVP reliability: PostgreSQL full backup every 24h, WAL archive every 5m, PITR window 14 days, retention (14 daily / 8 weekly / 12 monthly), RPO <=15m, RTO <=4h, plus weekly restore smoke tests and monthly full restore drills with required runbook ownership.
- [2026-02-14] DECISION :: Manual corporate-action backlog behavior finalized: unresolved cases keep only affected instruments provisional and visible with unresolved counters; unrelated instruments and global report generation remain available.
- [2026-02-14] DECISION :: Single-account `account_id` API contract finalized: keep `account_id` internal-only in MVP API payloads, use fixed configured account context in backend repositories, defer external multi-account API exposure to post-MVP.
- [2026-02-14] DECISION :: Task 1 runtime foundation implemented with project-native FastAPI package layout under `app/` and explicit layer boundaries (`adapters`, `mapping`, `ledger`, `analytics`, `api`, `jobs`, `db`, `domain`).
- [2026-02-14] DECISION :: Startup configuration is validated via `pydantic-settings` with `.env` support for local development plus environment variable overrides for deployment.
- [2026-02-14] PATTERN :: Health endpoint pattern finalized: API layer delegates DB connectivity checks to `DatabaseHealthPort` implementation in `app/db`, returning deterministic `200 ok` or `503 degraded` payloads.
- [2026-02-14] DECISION :: Container baseline for Task 1 uses root `Dockerfile` and `docker-compose.yml` with app+postgres services and postgres host port mapping `5433:5432` to avoid collision with local host PostgreSQL on `5432`.
- [2026-02-14] DECISION :: Task 2 schema strategy fixed to full column-level MVP schema in baseline migration (no partial identity-only placeholder schema).
- [2026-02-14] DECISION :: Task 2 primary-key strategy fixed to PostgreSQL database-generated UUIDs via `gen_random_uuid()` with `pgcrypto` extension enabled in migration baseline.
- [2026-02-14] DECISION :: Alembic migration infrastructure added (`alembic.ini`, `alembic/env.py`, `alembic/versions/*`) with database URL loaded from dedicated `config_load_database_url()` to avoid requiring full runtime credentials for migration commands.
- [2026-02-14] DECISION :: MVP schema baseline migration `20260214_01` creates all required Task 2 tables and frozen natural-key constraints (`uq_event_trade_fill_account_exec`, `uq_event_cashflow_account_txn_action_ccy`, `uq_event_fx_account_txn_ccy_pair`, `uq_event_corp_action_account_action`).
- [2026-02-14] PATTERN :: Migration regression test pattern added in `tests/test_db_migrations.py`: create temp DB, run `alembic upgrade head` twice, verify baseline tables/constraints, and skip safely when no reachable PostgreSQL credentials are available.
- [2026-02-14] DECISION :: Credentials hardening baseline: `docker-compose.yml` uses environment-variable interpolation only; real secrets live in local `.env` (gitignored), and `.env.example` is the committed template for required variables.
- [2026-02-14] DECISION :: Task 3 ingestion trigger surfaces now include both API (`POST /ingestion/run`) and CLI (`python -m app.main ingestion-run`) using a shared orchestrator path.
- [2026-02-14] DECISION :: Single-account runtime context is now explicit via required `ACCOUNT_ID` setting and is persisted on ingestion runs.
- [2026-02-14] PATTERN :: Ingestion run overlap prevention uses account-scoped PostgreSQL advisory transaction locks plus active `status='started'` check, raising deterministic `run already active` conflict semantics.
- [2026-02-14] PATTERN :: Required Flex section preflight is centralized in `app/jobs/section_preflight.py` with frozen hard/reconciliation matrices and deterministic `MISSING_REQUIRED_SECTION` diagnostics payload.
- [2026-02-14] PATTERN :: Stage timeline diagnostics are standardized as JSON array events (`stage`, `status`, `at_utc`, optional `details`) via `app/domain/timeline.py` and persisted in `ingestion_run.diagnostics`.
- [2026-02-14] PATTERN :: DATABASE_URL selection must follow execution mode: host-shell commands use `127.0.0.1:5433`, container-network commands use `postgres:5432`.
- [2026-02-14] DECISION :: Task 4 raw persistence uses dedicated immutable `raw_artifact` table with DB-enforced unique key (`account_id`, `period_key`, `flex_query_id`, `payload_sha256`) rather than `raw_record`-only dedupe.
- [2026-02-14] PATTERN :: Ingestion persist stage now computes payload SHA-256 once, upserts `raw_artifact`, extracts section rows from all detected Flex sections, and writes conflict-aware `raw_record` rows linked by `raw_artifact_id`.
- [2026-02-14] DECISION :: Duplicate raw artifact ingests remain normal successful runs; diagnostics explicitly expose dedupe/no-op outcomes (`raw_artifact_deduplicated`, inserted/deduplicated row counts).
- [2026-02-14] PATTERN :: Live ingestion troubleshooting rule: when preflight emits `MISSING_REQUIRED_SECTION`, request the operator to add the missing sections in IBKR Flex query configuration before re-running.
- [2026-02-14] DECISION :: Task 5 canonical mapping is fail-fast by policy: any canonical contract violation aborts the active run and finalizes with failure diagnostics rather than partial-success continuation.
- [2026-02-14] PATTERN :: Canonical persistence is centralized in `app/db/canonical_persistence.py`: conid-first instrument upsert plus frozen natural-key UPSERT behavior for trade/cashflow/fx/corporate-action events.
- [2026-02-14] DECISION :: Cashflow correction policy is frozen: duplicate natural key with changed amount/report date is treated as correction (`is_correction=true`) and latest values are upserted, not hard-failed.
- [2026-02-14] DECISION :: Task 5 reprocess surfaces are available via both API (`POST /ingestion/reprocess`) and CLI (`python -m app.main reprocess-run`) using deterministic replay from immutable `raw_record` data only.
- [2026-02-14] PATTERN :: Shared canonical pipeline helper (`app/jobs/canonical_pipeline.py`) is the single path used by ingestion and reprocess orchestrators to enforce identical mapping+persistence behavior and diagnostics counters.
- [2026-02-14] DECISION :: Root `pytest.ini` is configured with `testpaths=tests` and `norecursedirs` excluding `references/` so default `pytest` runs only first-party project tests.
- [2026-02-14] FIX :: Canonical persistence performance bottleneck resolved by adding batched event upserts in one shared transaction (`db_canonical_bulk_upsert`) and routing canonical pipeline writes through that bulk path to avoid per-row transaction overhead on large IBKR payloads.
- [2026-02-14] PATTERN :: Ingestion and reprocess timelines now persist `canonical_duration_ms` in `canonical_mapping` completed-stage details to make canonical-stage performance regressions visible in run diagnostics.
- [2026-02-14] DECISION :: Ingestion canonical mapping scope is run-scoped (`ingestion_run_id`) so each raw import is canonicalized once; repeated deduplicated imports finalize canonical stage as no-op with `canonical_skip_reason=no_new_raw_rows_for_run`, while reprocess remains period/query replay.
- [2026-02-14] PATTERN :: Ingestion API run list/detail serializers project canonical stage summary fields (`canonical_input_row_count`, `canonical_duration_ms`, `canonical_skip_reason`) from diagnostics so operational performance and skip reasons are visible without reading full timeline JSON.
- [2026-02-14] FIX :: `GET /ingestion/runs` now enforces frozen list contract behavior: accepts `sort_by`/`sort_dir`, clamps oversized `limit` to `API_MAX_LIMIT`, and returns `page.applied_limit` plus `sort` metadata.
- [2026-02-14] FIX :: Reprocess scope is now explicitly overridable at trigger time via API/CLI (`period_key`, `flex_query_id`) using `CanonicalReprocessOrchestrator.job_execute_reprocess_target` with strict `YYYY-MM-DD` validation.
- [2026-02-14] FIX :: Raw row persistence throughput improved by batching `raw_record` inserts in one execute call and computing inserted/deduplicated counts from `RETURNING` rows instead of per-row insert loops.
- [2026-02-14] FIX :: `FlexWebServiceAdapter` transport/polling hardening: URL transport timeouts now raise `TimeoutError`, poll retries now include both `1019` (statement in progress) and `1018` (throttled) with deterministic retry-delay overrides, and adapter diagnostics now persist `download` retry events with attempt/error/retry metadata.
- [2026-02-14] FIX :: Flex poll retry matrix expanded to include upstream server-busy code `1009`; adapter now treats `1009`/`1018`/`1019` as retryable with deterministic delay mapping.
- [2026-02-14] FIX :: Canonical UUID validation is now parse-strict (`uuid.UUID(...)`) in `app/db/canonical_persistence.py`; 36-character non-UUID strings are rejected at validation boundary before SQL execution.
- [2026-02-14] FIX :: Mapping and raw extraction date parsing now accept additional IBKR date variants (`YYYY/MM/DD` plus timestamp-suffixed values split by `T`, `;`, or space) while preserving canonical `YYYY-MM-DD` output.
- [2026-02-14] PATTERN :: Orchestrators now finalize failed runs with deterministic error codes and return failed `JobExecutionResult` instead of re-raising wrapped runtime errors; diagnostics include traceback payload for post-mortem triage.
- [2026-02-14] FIX :: `FlexWebServiceAdapter` now uses a project-native IBKR error-code catalog (`1003`-`1021`) for deterministic fallback messages when upstream omits `ErrorMessage`; request and poll flows share the same normalized error extraction path.
- [2026-02-14] FIX :: `job_raw_extract_payload_rows` now recursively extracts leaf rows within nested section containers (e.g., `FxPositions -> FxLots -> FxLot`) and preserves deterministic section-level indexing for `source_row_ref`, preventing silent loss of nested raw data rows.
- [2026-02-14] FIX :: `job_raw_extract_payload_rows` now preserves ancestor XML attributes in nested leaf payloads (e.g., `Trades -> Account(id) -> Trade`) by merging parent container attributes into each extracted row while keeping child attribute precedence and stable source row refs.
- [2026-02-20] DECISION :: Added `references/ngv_reports_ibkr` (westonplatter/ngv_reports_ibkr) as an approved study-only repository; continue enforcing strict no-runtime-import boundary for all `references/` code.
- [2026-02-20] DECISION :: Added `references/ibflex2` (robcohen/ibflex2) as an approved study-only repository for maintained Flex parser compatibility patterns; enforce strict no-runtime-import boundary for all `references/` code.
- [2026-02-20] FIX :: `FlexWebServiceAdapter` poll retry strategy now uses exponential backoff with jitter (capped), while preserving deterministic IBKR code-specific minimum retry floors for `1009`/`1018`/`1019` via `max(calculated_wait, code_floor)`.
- [2026-02-20] PATTERN :: Flex retry strategy tuning is centralized in runtime settings (`IBKR_FLEX_*` retry fields) and wired through bootstrap into a dedicated adapter retry-strategy object for deterministic testing and reduced adapter state complexity.
- [2026-02-20] DECISION :: Improvement #2 (typed Flex exception hierarchy) is adopted with project-native names in `app/adapters/flex_errors.py`; adapter failures now express phase-aware intent (request/statement/transport/token) instead of relying on broad built-in exception semantics.
- [2026-02-20] PATTERN :: Ingestion and reprocess orchestrators classify adapter-typed failures into deterministic run error codes (`*_TOKEN_EXPIRED_ERROR`, `*_TOKEN_INVALID_ERROR`, `*_REQUEST_ERROR`, `*_STATEMENT_ERROR`) while preserving existing timeout/connection/contract fallback mapping.
- [2026-02-20] DECISION :: Improvement #3 evaluation concluded NO-GO (no new code): current project already separates token lifecycle errors end-to-end (`1012 -> FlexTokenExpiredError -> INGESTION_TOKEN_EXPIRED_ERROR`, `1015 -> FlexTokenInvalidError -> INGESTION_TOKEN_INVALID_ERROR`) with existing regression coverage in adapter/orchestrator tests.
- [2026-02-20] DECISION :: Improvement #4 is adopted (GO): `FlexWebServiceAdapter` now uses a persistent pooled `httpx.Client` transport instead of per-call `urllib` requests, preserving existing retry/error/timeline contracts while reducing connection setup overhead on request+poll flows.
- [2026-02-20] DECISION :: Improvement #5 is adopted (GO): Flex error-code semantics are centralized in `app/adapters/flex_error_codes.py` using `FlexErrorCode` enum plus canonical classification sets (`FLEX_RETRYABLE_POLL_CODES`, `FLEX_TOKEN_CODES`, `FLEX_FATAL_CODES`) and shared helpers for default-message/retry-delay routing; `FlexWebServiceAdapter` now reuses this single model while preserving existing typed exception and diagnostics behavior.
- [2026-02-20] FIX :: Flex payload structural validation is now shared in `app/jobs/flex_payload_validation.py`; both raw extraction and section preflight enforce `FlexStatements count` integrity against parsed `FlexStatement` nodes and fail fast on malformed count metadata.
- [2026-02-20] DECISION :: Canonical trade mapping now treats `Trades.dateTime` as required for execution rows; fallback synthesis of UTC-marked midnight timestamps from report date was removed to prevent misleading temporal ordering.
- [2026-02-20] FIX :: Canonical pipeline contract is now strict bulk-only (`CanonicalPersistenceRepositoryPort.db_canonical_bulk_upsert` required); legacy `hasattr` fallback path removed and `instrument_upsert_count` now reports unique instrument writes (post-conid dedupe) rather than raw request cardinality.
- [2026-02-20] FIX :: Raw artifact upsert now uses single-statement `INSERT ... ON CONFLICT DO UPDATE ... RETURNING` to eliminate the prior two-step `INSERT`+`SELECT` race window and preserve deterministic dedupe signaling.
- [2026-02-20] DECISION :: Improvement #1 is adopted (GO): canonical mapping now validates decimal-like field contracts before persistence (`quantity`, `tradePrice`, `amount`, `rate`, and optional numeric fields used by canonical requests) and raises `MappingContractViolationError` with section/source/field context instead of deferring failures to database `CAST` errors.
- [2026-02-20] DECISION :: Improvement #2 in `docs/ibkr_import_reference_improvements.md` is adopted (GO): canonical mapping now strictly parses timestamp fields at mapping boundary, requiring valid `Trades.dateTime` and validating optional `CashTransactions.dateTime`, with deterministic UTC ISO-8601 normalization and `MappingContractViolationError` on malformed values.
- [2026-02-20] DECISION :: Improvement #3 in `docs/ibkr_import_reference_improvements.md` is adopted (GO): shared Flex parsing helpers now live in `app/domain/flex_parsing.py`, and both `app/jobs/raw_extraction.py` and `app/mapping/service.py` reuse the same date/timestamp normalization logic to prevent parser drift.
- [2026-02-20] DECISION :: Improvement #1 in `docs/ibkr_import_reference_improvements.md` is adopted (GO): `FlexWebServiceAdapter._adapter_http_get` now applies timeout-only local transport retries (3 immediate attempts) before raising `FlexAdapterTimeoutError`, preserving existing poll-level retry behavior and deterministic error mapping.
- [2026-02-20] DECISION :: Improvement #2 in `docs/ibkr_import_reference_improvements.md` is adopted (GO): `FlexWebServiceAdapter` now parses `SendRequest` root `timestamp` metadata and persists normalized `broker_request_at_utc` in request-stage timeline details for ingestion traceability.